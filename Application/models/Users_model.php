<?php if ( ! defined( 'DEVIL_SYS_CORE_PATH' ) ) exit( 'No direct script access allowed' );
/**
  @brief        Users Model ( 使用者模組 )
**/

class Users_Model extends Model
{
    /**
    @brief      建構子
    **/
    public function __construct()
    {
        parent::__construct();
    }

    /**
    @brief      取得當前登入者資料
    @retval     Mix / FALSE
    **/
    public function getCurrentUsers( $_uid = null )
    {
        # ----------------------------------------------------------------------
        # 若沒有指定使用者ID則使用當前的登入者資料
        # ----------------------------------------------------------------------
        $_uid = ( $_uid === null ) ? Core_LoadSession( 'id' ) : $_uid;
        # ----------------------------------------------------------------------
        # 組合SQL語法
        # ----------------------------------------------------------------------
        $sql = "!!SELECT * FROM  `k_user` WHERE `id` = ? LIMIT 0 , 1";
        # ----------------------------------------------------------------------
        # 取回執行後的結果
        # ----------------------------------------------------------------------
        $result = $this->db->query( $sql , array( $_uid ) );
        # ----------------------------------------------------------------------
        # 防呆判斷
        # ----------------------------------------------------------------------
        if ( ! $result )
        {
            return false;
        }
        else
        {
            # ------------------------------------------------------------------
            # 回傳資料集
            # ------------------------------------------------------------------
            return $result->fetch();
        }
    }

    /**
    @brief      取得當前登入者是否被禁止登入
    @return     INT / FALSE
    **/
    public function getStates( $_uid = null )
    {
        # ----------------------------------------------------------------------
        # 若沒有指定使用者ID則直接回傳錯誤
        # ----------------------------------------------------------------------
        if ( $_uid === null )
        {
            return false;
        }
        else
        {
            # ------------------------------------------------------------------
            # 取出指定的使用者ID資料，若沒有資料則回傳錯誤
            # ------------------------------------------------------------------
            $result = $this->getCurrentUsers( $_uid );
            # ------------------------------------------------------------------
            # 防呆判斷
            # ------------------------------------------------------------------
            if ( ! $result )
            {
                return false;
            }
            else
            {
                return $result['disabled'];
            }
        }
    }

    /**
    @brief      取得所有帳號
    @param      Int   $_page  分頁
    **/
    public function getUsers( $_id = 0, $_acl = 1 )
    {
        # ----------------------------------------------------------------------
        # 過濾
        # ----------------------------------------------------------------------
        $id = intval( $_id );
        # ----------------------------------------------------------------------
        # 初始化
        # ----------------------------------------------------------------------
        $result = array();
        # ----------------------------------------------------------------------
        # 組合語法
        # ----------------------------------------------------------------------
        $sql = "SELECT * FROM `k_user` WHERE ";
        $sql .= ( $_id != 0 ) ? "id = {$_id}" : "id != 1 ";
        $sql .= "and `acl` = {$_acl} ";
        # ----------------------------------------------------------------------
        # 執行
        # ----------------------------------------------------------------------
        $rs = Bootstart::$_lib[ 'Core_Pdo_Driver' ]->query($sql);
        # ----------------------------------------------------------------------
        # 有錯誤就中斷
        # ----------------------------------------------------------------------
        if ( ! $rs ) return $result;
        # ----------------------------------------------------------------------
        # 回傳
        # ----------------------------------------------------------------------
        if( $rs != "" )
        {
            return $rs->fetchAll();
        }
    }

    /**
    @brief      取得所有帳號
    @param      Int   $_page  分頁
    **/
    public function getUsersByAcc( $_acc = "" )
    {
        # ----------------------------------------------------------------------
        # 初始化
        # ----------------------------------------------------------------------
        $result = array();
        # ----------------------------------------------------------------------
        # 組合語法
        # ----------------------------------------------------------------------
        $sql = "SELECT `id` FROM `k_user` WHERE `account` = '{$_acc}'";
        # ----------------------------------------------------------------------
        # 執行
        # ----------------------------------------------------------------------
        $rs = Bootstart::$_lib[ 'Core_Pdo_Driver' ]->query($sql);
        # ----------------------------------------------------------------------
        # 有錯誤就中斷
        # ----------------------------------------------------------------------
        if ( ! $rs ) return $result;
        # ----------------------------------------------------------------------
        # 回傳
        # ----------------------------------------------------------------------
        if( $rs != "" )
        {
            return $rs->fetch();
        }
    }

    /**
    @brief  修改自已密碼
    @param String $_pass         密碼
    **/
    public function Set_Passwd( $_pass )
    {
        # ----------------------------------------------------------------------
        # 組合SQL語法
        # ----------------------------------------------------------------------
        $sql = "UPDATE `k_user` SET `pass` = :pass , `updateid` = :updateid  , `chgpwdt` = :chgpwdt  WHERE `id` = :id ";
        # ----------------------------------------------------------------------
        # 取回執行後的結果
        # ----------------------------------------------------------------------
        return $this->db->query_execute( $sql , array( ':pass' => $_pass , ':updateid' => Core_LoadSession( 'id' ) , ':chgpwdt' => time() , ':id' => Core_LoadSession( 'id' ) ) );
    }
}