<?php if ( ! defined( 'DEVIL_SYS_CORE_PATH' ) ) exit( 'No direct script access allowed' );
/**
  @brief        Member Controller ( 會員列表控制器 )
**/

class Member extends Controller
{
    /**
    @brief      建構子
    **/
    public function __construct()
    {
        # ----------------------------------------------------------------------
        # 呼叫 "父類別" 的 __backstageInit Method
        # ----------------------------------------------------------------------
        $this->__backstageInit();
        # ----------------------------------------------------------------------
        # 在此處統一判斷有無 "帳號管理" , 沒權限導向到首頁
        # ----------------------------------------------------------------------
        if ( Bootstart::$_lib['My_Power']->isPower( 3 ) === FALSE )
        {
            Core_Redirect( 'Op' );
        }
        # ----------------------------------------------------------------------
        # 手動載入需要的類別
        # ----------------------------------------------------------------------
        Bootstart::$_lib[ 'Core_Loader' ]->model( array( 'Users' ) );
        # ----------------------------------------------------------------------
        # 重新建構類別
        # ----------------------------------------------------------------------
        $this->__initialization();
    }

    /**
    @brief      index處理導向
    **/
    public function index( $_type = 'list', $_id = 0 )
    {
        # ----------------------------------------------------------------------
        # 過濾參數
        # ----------------------------------------------------------------------
        $id = intval( $_id );
        # ----------------------------------------------------------------------
        # 全部轉小寫，方便判斷
        # ----------------------------------------------------------------------
        switch( strtolower( $_type ) )
        {
            # ------------------------------------------------------------------
            # 預設列表畫面
            # ------------------------------------------------------------------
            case 'list':
                self::_datalist( );
                break;
            # ------------------------------------------------------------------
            # 新增
            # ------------------------------------------------------------------
            case 'add':
            # ------------------------------------------------------------------
            # 修改
            # ------------------------------------------------------------------
            case 'edit':
                self::_add( $id );
                break;
            # ------------------------------------------------------------------
            # 修改處理程序
            # ------------------------------------------------------------------
            case 'post':
                    self::_post( );
                    break;
            # ------------------------------------------------------------------
            # 上傳圖片
            # ------------------------------------------------------------------
            case 'upd_logo':
                self::_upd_logo( $id );
                break;
            # ------------------------------------------------------------------
            # 圖片上傳程序
            # ------------------------------------------------------------------
            case 'upd':
                self::_upd( );
                break;
            # ------------------------------------------------------------------
            # 刪除
            # ------------------------------------------------------------------
            case 'del':
                self::_del( $id );
                break;
        }
    }

    /**
    @brief      管理員列表( 首頁 )
    **/
    public function _datalist( )
    {
        # ----------------------------------------------------------------------
        # 初始化變數
        # ----------------------------------------------------------------------
        $list = "";
        # ----------------------------------------------------------------------
        # 取出所有帳號
        # ----------------------------------------------------------------------
        $dataArr =  Bootstart::$_mod[ 'Users_Model' ]->getUsers( 0, 1 );
        # ----------------------------------------------------------------------
        # 防呆 有資料才做
        # ----------------------------------------------------------------------
        if( $dataArr )
        {
            # ------------------------------------------------------------------
            # 產生 Table
            # ------------------------------------------------------------------
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_table( '' , 'table table-striped table-bordered table-hover table-checkable align-center' );
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_TSection( 'thead' );
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_row();
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( '#' , 'th' );
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( '帳號' , 'th' );
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( '名稱' , 'th' );
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( '狀態' , 'th' );
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( '功能' , 'th' );
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_TSection( 'tbody' );
            # ------------------------------------------------------------------
            # tag狀態
            # ------------------------------------------------------------------
            $enabled = array(
                '0' => '<span class="label label-danger">停用</span>' ,
                '1' => '<span class="label label-success">啟用</span>'
            );
            # ------------------------------------------------------------------
            # 產生tr
            # ------------------------------------------------------------------
            foreach( $dataArr as $key => $val )
            {
                # --------------------------------------------------------------
                # 產生功能按鈕
                # --------------------------------------------------------------
                $edit = '<a class="btn btn-xs bs-tooltip" href="'.DEVIL_APP_Url.__CLASS__."/index/edit/".$val['id'].'" title="修改"><i class="icon-edit"></i></a>&nbsp;&nbsp;'
                      . '<button class="btn btn-xs bs-tooltip btn-danger" title="Delete" onClick="del('.$val['id'].')"><i class="icon-trash"></i></button>';
                # --------------------------------------------------------------
                # tr
                # --------------------------------------------------------------
                Bootstart::$_lib[ 'Core_HtmlTable' ]->add_row();
                Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( $val[ 'id' ] );
                Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( $val[ 'account' ] );
                Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( $val[ 'name' ] );
                Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( $enabled[ $val[ 'enabled' ] ] );
                Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( $edit );
            }
            # ------------------------------------------------------------------
            # 產生所有設定的表格資料
            # ------------------------------------------------------------------
            $list = Bootstart::$_lib[ 'Core_HtmlTable' ]->generate();
        }
        else
        {
            $list = '<div class="alert alert-info alert-dismissible">
                        <h5><i class="icon fas fa-info"></i> 無任何資料！！</h5>
                    </div>';
        }
        # ----------------------------------------------------------------------
        # 輸出內容
        # ----------------------------------------------------------------------
        $this->My_HtmlView->Extension_HtmlView
        (
            __CLASS__.".Page" ,
            __CLASS__.".html" ,
            array
            (
                # --------------------------------------------------------------
                # 站名
                # --------------------------------------------------------------
                "TITLE" => DEVIL_APP_PROJECT_NAME,
                # --------------------------------------------------------------
                # JS、CSS、圖片等的存取網址
                # --------------------------------------------------------------
                "PUBLIC_URL" => DEVIL_APP_PUBLIC_URL,
                # --------------------------------------------------------------
                # 當前網址
                # --------------------------------------------------------------
                "URL" => DEVIL_APP_Url,
                # --------------------------------------------------------------
                # 資料
                # --------------------------------------------------------------
                "LIST" => $list,
                # --------------------------------------------------------------
                # 新增管理員
                # --------------------------------------------------------------
                "ADD" => DEVIL_APP_Url . __CLASS__ . '/index/add/',
                # --------------------------------------------------------------
                # 刪除管理員
                # --------------------------------------------------------------
                "DEL" => DEVIL_APP_Url . __CLASS__ . '/index/del/',
            )
        );
    }

    /**
    @brief      管理員列表( 新增、修改頁面 )
    **/
    private function _add( $_id )
    {
        # ----------------------------------------------------------------------
        # 初始化
        # ----------------------------------------------------------------------
        $htmlArr[ "account" ] = "";
        $htmlArr[ "name" ] = "";
        $htmlArr[ "enabled0" ] = "";
        $htmlArr[ "enabled1" ] = "checked='checked'";
        $htmlArr[ "HIDDEN_ID" ] = "";
        $htmlArr[ "button" ] = "新增";
        # ----------------------------------------------------------------------
        # 這裡處理修改
        # ----------------------------------------------------------------------
        if( $_id )
        {
            $user = Bootstart::$_mod[ 'Users_Model' ]->getUsers( $_id );
            # ------------------------------------------------------------------
            # 防呆
            # ------------------------------------------------------------------
            if( ! $user )
            {
                show_errormsg( "查無此帳號！！" );
            }
            # ------------------------------------------------------------------
            # 會員資料
            # ------------------------------------------------------------------
            $htmlArr = $user[ 0 ];
            # ------------------------------------------------------------------
            # 處理『狀態』
            # ------------------------------------------------------------------
            $htmlArr[ "enabled0" ] = ( ( $user[ 0 ][ "enabled" ] == 0 ) ? 'checked="checked"' : "" );
            $htmlArr[ "enabled1" ] = ( ( $user[ 0 ][ "enabled" ] == 1 ) ? 'checked="checked"' : '' );
            # ------------------------------------------------------------------
            # ID
            # ------------------------------------------------------------------
            $htmlArr[ "HIDDEN_ID" ] = '<input type="hidden" name="id" value="'.$user[ 0 ][ "id" ].'" />';
            # ------------------------------------------------------------------
            # 按鈕文字
            # ------------------------------------------------------------------
            $htmlArr[ "button" ] = "修改";
        }
        $htmlArr[ "TITLE" ] = DEVIL_APP_PROJECT_NAME;
        $htmlArr[ "PUBLIC_URL" ] = DEVIL_APP_PUBLIC_URL;
        $htmlArr[ "URL" ] = DEVIL_APP_Url;
        $htmlArr[ "POST_URL" ] = DEVIL_APP_Url . __CLASS__ . '/index/post/';
        # ----------------------------------------------------------------------
        # 輸出內容
        # ----------------------------------------------------------------------
        $this->My_HtmlView->Extension_HtmlView
        (
            __CLASS__."_Add_Page" ,
            __CLASS__."_Add.html" ,
            $htmlArr
        );
    }

    /**
    @brief      管理員列表( 新增、俢改程序 )
    **/
    private function _post( )
    {
        if ( Core_IsPost() && $_POST != '' )
        {
            # ------------------------------------------------------------------
            # 初始化變數
            # ------------------------------------------------------------------
            $id = $pass = $name = $account = '';
            # ------------------------------------------------------------------
            # 判斷是修改 還是 新增
            # ------------------------------------------------------------------
            if( isset( $_POST[ 'id' ] ) )
            {
                # --------------------------------------------------------------
                # 過濾『ID』
                # --------------------------------------------------------------
                $id = Bootstart::$_lib[ 'Core_Input' ]->post( 'id' , 'int' );
                # --------------------------------------------------------------
                # 錯誤輸出
                # --------------------------------------------------------------
                if ( ! $id  )
                {
                    show_errormsg( '重大錯誤！！' );
                }
            }
            else
            {
                # --------------------------------------------------------------
                # 過濾『帳號』
                # --------------------------------------------------------------
                $account = Bootstart::$_lib[ 'Core_Input' ]->post( 'account' , 'account' );
                # --------------------------------------------------------------
                # 錯誤輸出
                # --------------------------------------------------------------
                if ( ! $account  )
                {
                    show_errormsg( "帳號 - " . Bootstart::$_lib[ 'Core_Input' ]->getRuleMsg( 'account' ) );
                }
            }
            # ------------------------------------------------------------------
            # 非必填 檢查有送資料在檢查格式
            # ------------------------------------------------------------------
            if( !empty( $_POST[ 'name' ] ) )
            {
                # --------------------------------------------------------------
                # 過濾『名稱』
                # --------------------------------------------------------------
                $name = Bootstart::$_lib[ 'Core_Input' ]->post( 'name' , 'string' );
                # --------------------------------------------------------------
                # 錯誤輸出
                # --------------------------------------------------------------
                if ( ! $name  )
                {
                    show_errormsg( '名稱格式不符！！' );
                }
            }
            # ------------------------------------------------------------------
            # 非必填 檢查有送資料在檢查格式
            # ------------------------------------------------------------------
            if( !empty( $_POST[ 'password' ] ) )
            {
                # --------------------------------------------------------------
                # 過濾『密碼』
                # --------------------------------------------------------------
                $pass = Bootstart::$_lib[ 'Core_Input' ]->post( 'password' , 'pass' );
                # --------------------------------------------------------------
                # 錯誤輸出
                # --------------------------------------------------------------
                if ( ! $pass  )
                {
                    show_errormsg( "密碼 - " . Bootstart::$_lib[ 'Core_Input' ]->getRuleMsg( 'pass' ) );
                }
            }
            # ------------------------------------------------------------------
            # 過濾『狀態』
            # ------------------------------------------------------------------
            $enabled = Bootstart::$_lib[ 'Core_Input' ]->post( 'enabled' , 'int' );
            $enabled = ( ( $enabled == false ) ? 0 :  intval( $enabled ) );
            # ------------------------------------------------------------------
            # 組成資訊
            # ------------------------------------------------------------------
            $dataArr = array();
            $dataArr[ 'name' ] = ( ( $name == '' ) ? $account : $name );
            $dataArr[ 'enabled' ] = $enabled;
            $dataArr[ 'acl' ] = 1;
            $dataArr[ 'pow' ] = 0;
            $dataArr[ "updateid" ] = Core_LoadSession( 'id' );
            $dataArr[ "updatedt" ] = date('Y-m-d H:i:s');
            $dataArr[ "updateip" ] = sprintf( "%u" , ip2long ( Bootstart::$_lib['Core_UserAgent']->ip ) );
            if( $pass )
            {
                $dataArr[ 'pass' ] = md5( $pass );
            }
            if( $account )
            {
                $dataArr[ 'account' ] = $account;
            }
            # ------------------------------------------------------------------
            # 如果有帶 ID 代表是修改
            # ------------------------------------------------------------------
            if( $id )
            {
                if( Bootstart::$_lib[ 'Core_Pdo_Driver' ]->db_update( 'k_user' , $dataArr , "id = {$id}" ) === FALSE )
                {
                    show_errormsg( '修改失敗，請重新輸入！！' );
                }
            }
            # ------------------------------------------------------------------
            # 新增這裡處理
            # ------------------------------------------------------------------
            else
            {
                if( Bootstart::$_lib[ 'Core_Pdo_Driver' ]->db_insert( 'k_user' , $dataArr ) === FALSE )
                {
                    show_errormsg( '新增失敗，請重新輸入！！' );
                }
            }
            Core_Redirect( __CLASS__ );
        }
        Core_Redirect( __CLASS__ );
    }

    /**
    @brief      管理員列表( 刪除 )
    **/
    private function _del( $_id )
    {
        # ----------------------------------------------------------------------
        # 過濾『ID』
        # ----------------------------------------------------------------------
        $id = intval( $_id );
        # ----------------------------------------------------------------------
        # 防呆
        # ----------------------------------------------------------------------
        if( $id )
        {
            # ------------------------------------------------------------------
            # 執行更新
            # ------------------------------------------------------------------
            if ( Bootstart::$_lib[ 'Core_Pdo_Driver' ]->query( "DELETE FROM `k_user` WHERE `id` = '{$id}'" ) === FALSE )
            {
                show_errormsg( '刪除失败！' );
            }
        }
        Core_Redirect( __CLASS__ );
    }
}