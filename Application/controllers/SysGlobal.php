<?php if ( ! defined( 'DEVIL_SYS_CORE_PATH' ) ) exit( 'No direct script access allowed' );
/**
  @brief        SysGlobal  Controller ( 關於全域設定 )
**/

class SysGlobal  extends Controller
{
    /**
    @brief      建構子
    **/
    public function __construct()
    {
        # ----------------------------------------------------------------------
        # 呼叫 "父類別" 的 __backstageInit Method
        # ----------------------------------------------------------------------
        $this->__backstageInit();
        # ----------------------------------------------------------------------
        # 在此處統一判斷有無 "帳號管理" , 沒權限導向到首頁
        # ----------------------------------------------------------------------
        if ( Bootstart::$_lib['My_Power']->isPower( 9 ) === FALSE )
        {
            Core_Redirect( 'Op' );
        }
        # ----------------------------------------------------------------------
        # 手動載入需要的類別
        # ----------------------------------------------------------------------
        Bootstart::$_lib[ 'Core_Loader' ]->model( array( 'KConfig' ) );
        # ----------------------------------------------------------------------
        # 重新建構類別
        # ----------------------------------------------------------------------
        $this->__initialization();
    }

    /**
    @brief      index處理導向
    **/
    public function index( $_type = 'list' )
    {
        # ----------------------------------------------------------------------
        # 全部轉小寫，方便判斷
        # ----------------------------------------------------------------------
        switch( strtolower( $_type ) )
        {
            # ------------------------------------------------------------------
            # 預設列表畫面
            # ------------------------------------------------------------------
            case 'list':
                self::_datalist( );
                break;
            # ------------------------------------------------------------------
            # 修改處理程序
            # ------------------------------------------------------------------
            case 'post':
                self::_post( );
                break;
        }

    }

    /**
    @brief      預設頁
    **/
    public function _datalist( )
    {
        # ----------------------------------------------------------------------
        # 取出所有 kconfig 的值
        # ----------------------------------------------------------------------
        $kConfig = Bootstart::$_mod[ 'KConfig_Model' ]->Supporter_GetAll_K_config();
        # ----------------------------------------------------------------------
        # 輸出內容
        # ----------------------------------------------------------------------
        $this->My_HtmlView->Extension_HtmlView
        (
            __CLASS__.".Page" ,
            __CLASS__.".html" ,
            array
            (
                # --------------------------------------------------------------
                # 站名
                # --------------------------------------------------------------
                "TITLE" => DEVIL_APP_PROJECT_NAME,
                # --------------------------------------------------------------
                # JS、CSS、圖片等的存取網址
                # --------------------------------------------------------------
                "PUBLIC_URL" => DEVIL_APP_PUBLIC_URL,
                # --------------------------------------------------------------
                # 當前網址
                # --------------------------------------------------------------
                "URL" => DEVIL_APP_Url,
                # --------------------------------------------------------------
                # 保存
                # --------------------------------------------------------------
                "POST_URL" => DEVIL_APP_Url . __CLASS__ . '/index/post/',
                # --------------------------------------------------------------
                # 免運設定
                # --------------------------------------------------------------
                "SHIPPING_FREE" => $kConfig[ "shipping_free" ],
                # --------------------------------------------------------------
                # 運費設定
                # --------------------------------------------------------------
                "SHIPPING" => $kConfig[ "shipping" ],
            )
        );
    }

    /**
    @brief      保存
    **/
    public function _post( )
    {
        if ( Core_IsPost() && $_POST != '' )
        {
            foreach( $_POST as $key => $val )
            {
                $val = ( intval( $val ) >= 0 ) ? intval( $val ) : 0;
                Bootstart::$_mod[ 'KConfig_Model' ]->Set( $key, $val );
            }
        }
        // 导向预设画面
        Core_Redirect(__CLASS__ . '/index');
    }
}