<?php if ( ! defined( 'DEVIL_SYS_CORE_PATH' ) ) exit( 'No direct script access allowed' );
/**
  @brief        Op Controller ( 登入後首頁控制器 )
**/

class Op extends Controller
{
    /**
    @brief      建構子
    **/
    public function __construct()
    {
        # ----------------------------------------------------------------------
        # 呼叫 "父類別" 的 __backstageInit Method
        # ----------------------------------------------------------------------
        $this->__backstageInit();
        $this->Core_Loader->library( array( 'HtmlView' ) );
        # ----------------------------------------------------------------------
        # 重新建構類別
        # ----------------------------------------------------------------------
        $this->__initialization();
    }

    /**
    @brief      登入後 看到的第一頁 ( 首頁 )
    **/
    public function index( $_pages = 1 )
    {
        # ----------------------------------------------------------------------
        # 輸出內容
        # ----------------------------------------------------------------------
        $this->My_HtmlView->Extension_HtmlView
        //$this->Core_HtmlView->render
        (
            "Op_Page" ,
            "Op.html" ,
            array
            (
                # --------------------------------------------------------------
                # 站名
                # --------------------------------------------------------------
                "TITLE" => DEVIL_APP_PROJECT_NAME ,
                # --------------------------------------------------------------
                # JS、CSS、圖片等的存取網址
                # --------------------------------------------------------------
                "PUBLIC_URL" => DEVIL_APP_PUBLIC_URL ,
                # --------------------------------------------------------------
                # 當前網址
                # --------------------------------------------------------------
                "URL" => DEVIL_APP_Url ,
            )
        );
    }

    /**
    @brief      修改密碼
    **/
    public function Change_Password( )
    {
        # ----------------------------------------------------------------------
        # 輸出內容
        # ----------------------------------------------------------------------
        $this->My_HtmlView->Extension_HtmlView
        (
            "Change_Password_Page" ,
            "Change_Password.html" ,
            array
            (
                # --------------------------------------------------------------
                # 站名
                # --------------------------------------------------------------
                "TITLE" => DEVIL_APP_PROJECT_NAME ,
                # --------------------------------------------------------------
                # JS、CSS、圖片等的存取網址
                # --------------------------------------------------------------
                "PUBLIC_URL" => DEVIL_APP_PUBLIC_URL ,
                # --------------------------------------------------------------
                # 當前網址
                # --------------------------------------------------------------
                "URL" => DEVIL_APP_Url ,
                # --------------------------------------------------------------
                # 修改路径
                # --------------------------------------------------------------
                "POST_URL" => DEVIL_APP_Url . __CLASS__ . '/Change_Password_post',
            )
        );
    }

    /**
    @brief      修改密碼處理
    **/
    public function Change_Password_post( )
    {
        if ( Core_IsPost() && $_POST != '' )
        {
            # ------------------------------------------------------------------
            # 手動載入需要的類別
            # ------------------------------------------------------------------
            Bootstart::$_lib[ 'Core_Loader' ]->model( array( 'Users' ) );
            # ------------------------------------------------------------------
            # 取出當前使用者資料
            # ------------------------------------------------------------------
            $tempArr = $this->Users_Model->getCurrentUsers( Core_LoadSession( 'id' ) );
            # ------------------------------------------------------------------
            # 舊密碼
            # ------------------------------------------------------------------
            $oldpassword = $_POST[ 'oldpassword' ];
            # ------------------------------------------------------------------
            # 如果舊密碼不同，就塞錯誤訊息
            # ------------------------------------------------------------------
            if ( md5( $oldpassword ) != $tempArr['pass'] )
            {
                show_errormsg( '舊密碼錯誤！！' );
            }
            # ------------------------------------------------------------------
            # 新密碼
            # ------------------------------------------------------------------
            $newpassword = $_POST[ 'newpassword' ];
            # ------------------------------------------------------------------
            # 再次確認新密碼
            # ------------------------------------------------------------------
            $renewpassword = $_POST[ 'renewpassword' ];
            # ------------------------------------------------------------------
            # 判斷新密碼,重複輸入新密碼比對有沒有一樣
            # ------------------------------------------------------------------
            if ( $newpassword !== $renewpassword )
            {
                show_errormsg( '新密碼需與再次输入新密碼相同！！' );
            }
            # ------------------------------------------------------------------
            # 執行
            # ------------------------------------------------------------------
            if ( $this->Users_Model->Set_Passwd( MD5( $newpassword ) ) )
            {
                Core_Redirect( 'Op' );
            }
        }
        else
        {
            Core_Redirect( 'Op' );
        }
    }
}