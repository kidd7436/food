<?php if ( ! defined( 'DEVIL_SYS_CORE_PATH' ) ) exit( 'No direct script access allowed' );
/**
  @brief        Login Controller ( 登入控制器 )
**/

class Login extends Controller
{
    /**
    @brief      建構子
    **/
    public function __construct()
    {
        # ----------------------------------------------------------------------
        # 呼叫父類別建構子
        # ----------------------------------------------------------------------
        parent::__construct();
    }

    /**
    @brief      判斷是否登入狀態 , 並驗證 COOKIE 是否正常
    **/
    private function ISLogin()
    {
        # ----------------------------------------------------------------------
        # 判斷cookie登入
        # ----------------------------------------------------------------------
        if ( Core_IsLoginCookie() === false )
        {
            # ------------------------------------------------------------------
            # 刪除登入的Cookie
            # ------------------------------------------------------------------
            $this->Core_Cookie->delete( '_c_chk' );
        }
        else
        {
            # ------------------------------------------------------------------
            # 導向至登入後的預設頁面
            # ------------------------------------------------------------------
            Core_Redirect( 'Op' );
        }
    }

    /**
    @brief      登出前處理
    **/
    private function before_Logout()
    {
        # ----------------------------------------------------------------------
        # 如果有 Core_Session 再執行 session_destroy() 避免出現錯誤訊息
        # 原因是使用 session_destroy() 之前必須要搭配 session_start()
        # ----------------------------------------------------------------------
        if ( isset( $this->Core_Session ) )
        {
            session_destroy();
        }
        # ----------------------------------------------------------------------
        # 刪除已載入的類別 Pdo、Session
        # ----------------------------------------------------------------------
        unset( $this->Core_Pdo_Driver , $this->Core_Session );
        # ----------------------------------------------------------------------
        # 刪除登入的Cookie
        # ----------------------------------------------------------------------
        $this->Core_Cookie->delete( '_c_chk' );
        # ----------------------------------------------------------------------
        # 刪除登入的Cookie
        # ----------------------------------------------------------------------
        $this->Core_Cookie->delete( 'PHPSESSID' );
    }

    /**
    @brief      登出處理
    **/
    public function logout()
    {
        # ----------------------------------------------------------------------
        # 載入需要的 class
        # ----------------------------------------------------------------------
        $this->Core_Loader->library( array( 'Pdo_Driver' , 'Session') );
        # ----------------------------------------------------------------------
        # 如果 Session 不存在就刪除 Session
        # ----------------------------------------------------------------------
        if ( isset( $_SESSION['Login_user']['id'] ) ) unset( $_SESSION['Login_user']['id'] );
        # ----------------------------------------------------------------------
        # 登出前處理
        # ----------------------------------------------------------------------
        $this->before_Logout();
        # ----------------------------------------------------------------------
        # 轉跳到登入頁
        # ----------------------------------------------------------------------
        Core_Redirect( 'Login' );
    }

    /**
    @brief      生成驗證碼圖片
    @param      String      $_EntryStr 加密後的字串
    @remarks    擾亂字串||時間戳記||驗證碼
    **/
    public function authImage( $_EntryStr )
    {
        # ----------------------------------------------------------------------
        # 判斷是否有設定來源網址，且等於當前網址
        # ----------------------------------------------------------------------
        if ( ! isset( $_SERVER['HTTP_REFERER'] ) )
        {
            exit( 'unknown.' );
        }
        elseif ( ! substr_count( $_SERVER['HTTP_REFERER'] , $_SERVER['SERVER_NAME'] ) )
        {
            exit( 'no service.' );
        }
        # ----------------------------------------------------------------------
        # 如果Cookie不存在，就離開
        # ----------------------------------------------------------------------
        if ( ! $this->Core_Cookie->get( '_justMoment' ) )
        {
            exit;
        }
        # ----------------------------------------------------------------------
        # 如果存在就刪除
        # ----------------------------------------------------------------------
        else
        {
            $this->Core_Cookie->delete( '_justMoment' );
        }
        # ----------------------------------------------------------------------
        # 使用扭曲版驗證碼
        # ----------------------------------------------------------------------
        $this->Core_Widget->captchaDis( $_EntryStr );
    }

    /**
    @brief      登入頁、登入處理
    **/
    public function index()
    {
        # ----------------------------------------------------------------------
        # 設定一個 Server Cookie 用來防止有人狂刷驗證碼
        # ----------------------------------------------------------------------
        $this->Core_Cookie->set( '_justMoment' , $this->Core_Widget->randString( 30 , 6 ) , 0 );
        # ----------------------------------------------------------------------
        # 載入需要的 Class
        # ----------------------------------------------------------------------
        $this->Core_Loader->library( array( 'HtmlForm' , 'HtmlView' ) );
        # ----------------------------------------------------------------------
        # 判斷是否為登入狀態
        # ----------------------------------------------------------------------
        $this->ISLogin();
        # ----------------------------------------------------------------------
        # 開始執行登入判斷
        # ----------------------------------------------------------------------
        if ( $this->Core_Input->post( 'login' , 'string' ) )
        {
            # ------------------------------------------------------------------
            # 輸入的驗證碼
            # ------------------------------------------------------------------
            $post_authnum = $this->Core_Input->post( "authnum" , 'string' );
            # ------------------------------------------------------------------
            # 加密的驗證碼字串
            # ------------------------------------------------------------------
            $post_capTcName = $this->Core_Input->post( "_capTcName" , 'string' );
            # ------------------------------------------------------------------
            # 如果沒有接收到post過來的值、或試驗證有誤，就離開
            # ------------------------------------------------------------------
            if ( ! $post_authnum || ! $post_capTcName )
            {
                Core_Redirect( 'Login' );
            }
            # ------------------------------------------------------------------
            # 驗證碼由傳入的參數解密後取出使用
            # ------------------------------------------------------------------
            $_EntryStrArr = explode( '||' , $this->Core_EncryptDecryt->decrypt( $post_capTcName ) );
            # ------------------------------------------------------------------
            # 如果解密後切割不是三個陣列，就跳出
            # ------------------------------------------------------------------
            if ( count( $_EntryStrArr ) != 3 )
            {
                Core_Redirect( 'Login' );
            }
            # ------------------------------------------------------------------
            # 有效時間 ( 三分鐘 )
            # ------------------------------------------------------------------
            if ( ( time() - $_EntryStrArr[1] ) > DEVIL_APP_CAPTCHAEXPIRE )
            {
                Core_Redirect( 'Login' );
            }
            # ------------------------------------------------------------------
            # 驗證用戶輸入是否和驗證碼一致
            # ------------------------------------------------------------------
            if ( $post_authnum == $_EntryStrArr[0] )
            {
                # --------------------------------------------------------------
                # 加載 Pdo、Session 的 class
                # --------------------------------------------------------------
                $this->Core_Loader->library( array( 'Pdo_Driver' , 'Session' ) );
                # --------------------------------------------------------------
                # 加載 Users、Login 的 model
                # --------------------------------------------------------------
                $this->Core_Loader->model( array( 'Users' , 'Login' , 'KConfig' ) );
                # --------------------------------------------------------------
                # 驗證POST過來的帳號
                # --------------------------------------------------------------
                $Post_login = $this->Core_Input->post( "login" , 'string' );
                $Post_login = ( ! $Post_login ) ? '' : $Post_login;
                # --------------------------------------------------------------
                # 驗證POST過來的密碼
                # --------------------------------------------------------------
                $Post_pass = $this->Core_Input->post( "pass" , 'string' );
                $Post_pass = ( ! $Post_pass ) ? '' : $Post_pass;
                # --------------------------------------------------------------
                # 利用POST過來的帳號密碼取出登入者的資料
                # --------------------------------------------------------------
                $UserArr = $this->Login_Model->Login_Result( $Post_login , $Post_pass );
                # --------------------------------------------------------------
                # 帳號登入
                # --------------------------------------------------------------
                if ( $UserArr['User_Count'] == 1 )
                {
                    # ----------------------------------------------------------
                    # 踢掉 幽靈人口
                    # ----------------------------------------------------------
                    $this->Core_Session->sess_KillGhost();
                    # ----------------------------------------------------------
                    # 非超級帳號登入時，要多判斷是否被停用
                    # ----------------------------------------------------------
                    if ( $UserArr['User_Data']['account'] != DEVIL_APP_SUPERACCOUNT )
                    {
                        if ( $this->Users_Model->getStates( $UserArr['User_Data']['id'] ) )
                        {
                            # --------------------------------------------------
                            # 踢掉相同帳號的會員 ( 在其他地方登入的 )
                            # --------------------------------------------------
                            $this->Core_Session->sess_KickMyself();
                            # --------------------------------------------------
                            # 轉跳前處理
                            # --------------------------------------------------
                            $this->Before_Logout();
                            # --------------------------------------------------
                            # 亂數取出一筆網址，並轉跳到其他網頁
                            # --------------------------------------------------
                            Core_Redirect( Bootstart::$_config['disabled'][array_rand( Bootstart::$_config['disabled'] )] , true );
                        }
                    }
                    # ----------------------------------------------------------
                    # 將資料寫入 Server Cookie
                    # ----------------------------------------------------------
                    $this->Core_Cookie->set( '_c_chk' , $post_capTcName , 0 );
                    # ----------------------------------------------------------
                    # 將必要資料寫入 SESSION
                    # ----------------------------------------------------------
                    $_SESSION['Login_user']['id'] = $UserArr['User_Data']['id'];
                    $_SESSION['Login_user']['pow'] = $UserArr['User_Data']['pow'];
                    $_SESSION['Login_user']['account'] = $UserArr['User_Data']['account'];
                    $_SESSION['Login_user']['name'] = $UserArr['User_Data']['name'];
                    # ----------------------------------------------------------
                    # 先將SESSION資料寫入
                    # ----------------------------------------------------------
                    session_commit();
                    # ----------------------------------------------------------
                    # 踢掉相同帳號的管理者 ( 在其他地方登入的 )
                    # ----------------------------------------------------------
                    if ( $UserArr['User_Data']['account'] != DEVIL_APP_SUPERACCOUNT )
                    {
                        $this->Core_Session->sess_KickMyself();
                    }
                    # ----------------------------------------------------------
                    # update session id ( 更新 k_sessions => uid 欄位 )
                    # ----------------------------------------------------------
                    $this->Login_Model->Login_UpdateUid( $UserArr['User_Data']['id'] , session_id() );
                    # ----------------------------------------------------------
                    # 用,號切割，因為IP會有 58.125.26.99 , 58 <---- 被截掉的情況
                    # ----------------------------------------------------------
                    $IP = explode( ',' , $this->Core_UserAgent->ip );
                    # ----------------------------------------------------------
                    # update Member's data for ip . lastdt ... ( 更新 k_user 資料表中的資料 )
                    # ----------------------------------------------------------
                    $this->Login_Model->Login_UserUpdate( $UserArr['User_Data']['id'] , $UserArr['User_Data']['logcount'] , time() , sprintf("%u", ip2long ( $IP[0] ) ) );
                    # ----------------------------------------------------------
                    # update k_log's Member data ( 載入純真IP資料庫類別，然後將當前獲取到的 IP 丟到純真IP類別中，再取出登入者的IP相關資訊對應 )
                    # ----------------------------------------------------------
                    $this->Core_Loader->library( array( 'IpLocation') );
                    $QQIpArr = $this->Core_IpLocation->getlocation( $IP[0] );
                    # ----------------------------------------------------------
                    # 新增一筆登入紀錄
                    # ----------------------------------------------------------
                    $this->Login_Model->Login_InsertLog( $QQIpArr );
                    # ----------------------------------------------------------
                    # 導向至登入後的頁面 => 預設的 index method ( function )
                    # ----------------------------------------------------------
                    Core_Redirect( 'Op' );
                }
                else
                {
                    Core_Redirect( 'Login' );
                }
            }
            else
            {
                Core_Redirect( 'Login' );
            }
        }
        else
        {
            # ------------------------------------------------------------------
            # 產生一組加密字串
            # ------------------------------------------------------------------
            $EntryStr = $this->Core_EncryptDecryt->encrypt( $this->Core_Widget->randString() . '||' . time() . '||' . $this->Core_Widget->randNum( 1 , 5 ) );
            # ------------------------------------------------------------------
            # 登出前處理
            # ------------------------------------------------------------------
            $this->Before_Logout();
            # ------------------------------------------------------------------
            # 產生 VIEW
            # ------------------------------------------------------------------
            $this->Core_HtmlView->render
            (
                "Login_page" ,
                "Login.html" ,
                array
                (
                    # ----------------------------------------------------------
                    # 當前網址
                    # ----------------------------------------------------------
                    "URL" => DEVIL_APP_Url ,
                    # ----------------------------------------------------------
                    # JS、CSS、圖片等的存取網址
                    # ----------------------------------------------------------
                    "PUBLIC_URL" => DEVIL_APP_PUBLIC_URL ,
                    # ----------------------------------------------------------
                    # 網頁 TITLE
                    # ----------------------------------------------------------
                    "TITLE" => DEVIL_APP_PROJECT_NAME ,
                    # ----------------------------------------------------------
                    # 登入驗證碼
                    # ----------------------------------------------------------
                    "CAPTCHA" => DEVIL_APP_Url . 'Login/authImage/' . $EntryStr ,
                    # ----------------------------------------------------------
                    # 丟給後台驗證的加密字串
                    # ----------------------------------------------------------
                    "CAPTCHAHIDDENINPUT" => $this->Core_HtmlForm->addInput( 'hidden', '_capTcName' , $EntryStr )
                )
            );
        }
    }
}