<?php if ( ! defined( 'DEVIL_SYS_CORE_PATH' ) ) exit( 'No direct script access allowed' );
/**
  @brief        BuyCart Controller ( 購物車 )
**/

class BuyCart extends Controller
{
    /**
    @brief      建構子
    **/
    public function __construct()
    {
        # ----------------------------------------------------------------------
        # 呼叫 "父類別" 的 __backstageInit Method
        # ----------------------------------------------------------------------
        $this->__backstageInit();
        # ----------------------------------------------------------------------
        # 手動載入需要的類別
        # ----------------------------------------------------------------------
        Bootstart::$_lib[ 'Core_Loader' ]->library( array( 'HtmlTable', 'Pdo_Driver', 'Session' ) );
        # ----------------------------------------------------------------------
        # 重新建構類別
        # ----------------------------------------------------------------------
        $this->__initialization();
    }

    /**
    @brief      登入後 看到的第一頁 ( 首頁 )
    **/
    public function index(  )
    {
        # ----------------------------------------------------------------------
        # 初始化
        # ----------------------------------------------------------------------
        $list = $nolist = "";
        $total = 0;
        # ----------------------------------------------------------------------
        # 防呆
        # ----------------------------------------------------------------------
        if( isset( $_SESSION[ "cart" ] ) && $_SESSION[ "cart" ] )
        {
            # ------------------------------------------------------------------
            # 取出所有商品資料
            # ------------------------------------------------------------------
            $product = self::arrToOne();
            # ------------------------------------------------------------------
            # 產生 Table
            # ------------------------------------------------------------------
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_table( '' , 'table' );
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_TSection( 'thead', 'thead-primary' );
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_row();
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( '' , 'th' );
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( '' , 'th' );
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( '商品名稱' , 'th' );
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( '金額' , 'th' );
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( '數量' , 'th' );
            Bootstart::$_lib[ 'Core_HtmlTable' ]->add_TSection( 'tbody' );
            # ------------------------------------------------------------------
            # 開始跑資料
            # ------------------------------------------------------------------
            foreach( $_SESSION[ "cart" ] as $key => $val )
            {
                # --------------------------------------------------------------
                # 防呆 如果商品不存在 就不顯示出來
                # --------------------------------------------------------------
                if( ! isset( $product[ $val[ 'title' ] ] ) ) continue;
                # --------------------------------------------------------------
                # 圖片路徑
                # --------------------------------------------------------------
                $img = DEVIL_APP_PUBLIC_URL.'images/product/'.$val[ "id" ].'.png';
                # --------------------------------------------------------------
                # 取出金額
                # --------------------------------------------------------------
                $money = min( $product[ $val[ 'title' ] ][ "money" ], $product[ $val[ 'title' ] ][ "discount" ] );
                # --------------------------------------------------------------
                # 總計
                # --------------------------------------------------------------
                $total += $money * $val[ 'quantity' ];
                # --------------------------------------------------------------
                # tr
                # --------------------------------------------------------------
                Bootstart::$_lib[ 'Core_HtmlTable' ]->add_row( 'text-center' );
                Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( '<a href="javascript:" onclick="remove( '.$val[ 'id' ].' )"><span class="ion-ios-close"></span></a>', 'data', 'product-remove' );
                Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( '<div class="img" style="background-image:url('.$img.');"></div>', 'data', 'image-prod' );
                Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( '<h3>'.$val[ 'title' ].'</h3>', 'data', 'product-name' );
                Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( $money, 'data', 'price' );
                Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( '<div class="input-group mb-3"><input type="text" name="product['.$val[ 'id' ].'][quantity]" class="quantity form-control input-number" value="'.$val[ 'quantity' ].'" min="1" max="100"></div>', 'data', 'quantity' );
                Bootstart::$_lib[ 'Core_HtmlTable' ]->add_cell( '<input type="hidden" name="product['.$val[ 'id' ].'][id]"  value="'.$val[ 'id' ].'">' );
            }
            # ------------------------------------------------------------------
            # 產生所有設定的表格資料
            # ------------------------------------------------------------------
            $list = Bootstart::$_lib[ 'Core_HtmlTable' ]->generate();
        }
        else
        {
            $list .= '<div class="py-3 bg-secondary text-center">購物車目前沒有商品，快去選購！！<a href="'.DEVIL_APP_Url.'LunchBox">點此去</a></div>';
        }
        # ----------------------------------------------------------------------
        # 輸出內容
        # ----------------------------------------------------------------------
        Bootstart::$_lib[ 'My_HtmlView' ]->Extension_HtmlView
        (
            __CLASS__."_Page" ,
            __CLASS__.".html" ,
            array
            (
                # --------------------------------------------------------------
                # 當前網址
                # --------------------------------------------------------------
                "URL" => DEVIL_APP_Url ,
                # --------------------------------------------------------------
                # JS、CSS、圖片等的存取網址
                # --------------------------------------------------------------
                "PUBLIC_URL" => DEVIL_APP_PUBLIC_URL ,
                # --------------------------------------------------------------
                # 網頁 TITLE
                # --------------------------------------------------------------
                "TITLE" => DEVIL_APP_PROJECT_NAME ,
                # --------------------------------------------------------------
                # 內容
                # --------------------------------------------------------------
                "LIST" => $list ,
                # --------------------------------------------------------------
                # 總計
                # --------------------------------------------------------------
                "TOTAL" => $total,
                # --------------------------------------------------------------
                # 刪除購物車
                # --------------------------------------------------------------
                "BUYCART_URL" => DEVIL_APP_Url.'BuyCart/addItem/0' ,
                # --------------------------------------------------------------
                # 檢查是否已登入
                # --------------------------------------------------------------
                "ISLOGINURL" => DEVIL_APP_Url.'BuyCart/ISLogin' ,
                # --------------------------------------------------------------
                # 詳細訂單
                # --------------------------------------------------------------
                "CHECKOUT_URL" => DEVIL_APP_Url.'BuyCart/checkOut' ,
            )
        );
    }

    /**
    @brief      詳細
    **/
    public function checkOut(  )
    {
        # ----------------------------------------------------------------------
        # 初始化
        # ----------------------------------------------------------------------
        $subtotal = 0;
        # ----------------------------------------------------------------------
        # 防呆
        # ----------------------------------------------------------------------
        if( isset( $_SESSION[ "cart" ] ) )
        {
            # ------------------------------------------------------------------
            # 取出所有商品資料
            # ------------------------------------------------------------------
            $product = self::arrToOne();
            # ------------------------------------------------------------------
            # 整理資料
            # ------------------------------------------------------------------
            foreach( $_SESSION[ "cart" ] as $key => $val )
            {
                # --------------------------------------------------------------
                # 取出金額
                # --------------------------------------------------------------
                $money = min( $product[ $val[ 'title' ] ][ "money" ], $product[ $val[ 'title' ] ][ "discount" ] );
                # --------------------------------------------------------------
                # 總計
                # --------------------------------------------------------------
                $subtotal += $money * $val[ 'quantity' ];
            }
        }
        # ----------------------------------------------------------------------
        # 輸出內容
        # ----------------------------------------------------------------------
        Bootstart::$_lib[ 'My_HtmlView' ]->Extension_HtmlView
        (
            "checkOut_Page" ,
            "checkOut.html" ,
            array
            (
                # --------------------------------------------------------------
                # 當前網址
                # --------------------------------------------------------------
                "URL" => DEVIL_APP_Url ,
                # --------------------------------------------------------------
                # JS、CSS、圖片等的存取網址
                # --------------------------------------------------------------
                "PUBLIC_URL" => DEVIL_APP_PUBLIC_URL ,
                # --------------------------------------------------------------
                # 網頁 TITLE
                # --------------------------------------------------------------
                "TITLE" => DEVIL_APP_PROJECT_NAME,
                # --------------------------------------------------------------
                # 姓名
                # --------------------------------------------------------------
                "NAME" => $_SESSION[ "Login_user" ][ "name" ],
                # --------------------------------------------------------------
                # 電話
                # --------------------------------------------------------------
                "PHONE" => $_SESSION[ "Login_user" ][ "phone" ],
                # --------------------------------------------------------------
                # 地址
                # --------------------------------------------------------------
                "ADDRESS" => $_SESSION[ "Login_user" ][ "address" ],
                # --------------------------------------------------------------
                # 地址
                # --------------------------------------------------------------
                "MAIL" => $_SESSION[ "Login_user" ][ "account" ],
                # --------------------------------------------------------------
                # 小計
                # --------------------------------------------------------------
                "SUBTOTAL" => $subtotal,
                # --------------------------------------------------------------
                # POST_URL
                # --------------------------------------------------------------
                "ORDER_URL" => DEVIL_APP_Url.'BuyCart/order' ,
            )
        );
    }
    
    /**
    @brief      購物車新增商品
    **/
    public function addItem( $_type )
    {
        if( Core_IsPost() && $_POST != '' )
        {
            # ------------------------------------------------------------------
            # 0刪除 1新增
            # ------------------------------------------------------------------
            if( $_type )
            {
                # --------------------------------------------------------------
                # 檢查商品是否已存在購物車
                # --------------------------------------------------------------
                if( !isset( $_SESSION[ "cart" ][ $_POST[ "id" ] ] ) )
                {
                    # ----------------------------------------------------------
                    # 加入 SESSION
                    # ----------------------------------------------------------
                    $_SESSION[ "cart" ][ $_POST[ "id" ] ] = $_POST;
                    # ----------------------------------------------------------
                    # 寫入 SESSION
                    # ----------------------------------------------------------
                    session_commit();
                    # ----------------------------------------------------------
                    # 加入 SESSION
                    # ----------------------------------------------------------
                    $this->responseJSON( '' , 400 , "商品已加入購物車！！" );exit;
                }
                else
                {
                    $this->responseJSON( '' , 400 , "商品已存在購物車！！" );exit;
                }
            }
            else
            {
                # --------------------------------------------------------------
                # 檢查商品是否已存在購物車
                # --------------------------------------------------------------
                if( isset( $_SESSION[ "cart" ][ $_POST[ "id" ] ] ) )
                {
                    unset( $_SESSION[ "cart" ][ $_POST[ "id" ] ] );
                    # ----------------------------------------------------------
                    # 加入 SESSION
                    # ----------------------------------------------------------
                    $this->responseJSON( '' , 400 , "商品已刪除！！" );exit;
                }
            }

        }
    }

    /**
    @brief      訂單
    **/
    public function order( )
    {
        if( Core_IsPost() && $_POST != '' )
        {
            # ------------------------------------------------------------------
            # 防呆
            # ------------------------------------------------------------------
            if( ! isset( $_POST[ "name" ] ) )
            {
                echo "<script>alert('收件人不得為空！！')</script>";
                exit( "<a href='javascript:history.back()'>回上一頁</a>" );
            }
            # ------------------------------------------------------------------
            # 防呆
            # ------------------------------------------------------------------
            if( ! isset( $_POST[ "phone" ] ) )
            {
                echo "<script>alert('電話不得為空！！')</script>";
                exit( "<a href='javascript:history.back()'>回上一頁</a>" );
            }
            # ------------------------------------------------------------------
            # 防呆
            # ------------------------------------------------------------------
            if( ! isset( $_POST[ "address" ] ) )
            {
                echo "<script>alert('地址不得為空！！')</script>";
                exit( "<a href='javascript:history.back()'>回上一頁</a>" );
            }
            # ------------------------------------------------------------------
            # 防呆
            # ------------------------------------------------------------------
            if( ! isset( $_POST[ "mail" ] ) )
            {
                echo "<script>alert('E-mail不得為空！！')</script>";
                exit( "<a href='javascript:history.back()'>回上一頁</a>" );
            }
            # ------------------------------------------------------------------
            # 初始化
            # ------------------------------------------------------------------
            $money = $total = 0;
            $content  = "";
            # ------------------------------------------------------------------
            # 取出所有商品資料
            # ------------------------------------------------------------------
            $product = self::arrToOne();
            # ------------------------------------------------------------------
            # 組合商品內容
            # ------------------------------------------------------------------
            foreach( $_SESSION[ "cart" ] as $key => $val )
            {
                $dataArr = array();
                # --------------------------------------------------------------
                # 防呆 不符合就離開
                # --------------------------------------------------------------
                if( ! isset( $product[ $val[ "title" ] ] ) ) continue;
                # --------------------------------------------------------------
                # 商品內容暫存
                # --------------------------------------------------------------
                $dataArr = $product[ $val[ "title" ] ];
                # --------------------------------------------------------------
                # 商品內容
                # --------------------------------------------------------------
                $content .= $dataArr[ "title" ] . '*' .$val[ "quantity" ];
                # --------------------------------------------------------------
                # 取出金額
                # --------------------------------------------------------------
                $money = min( $dataArr[ "money" ], $dataArr[ "discount" ] );
                # --------------------------------------------------------------
                # 總計
                # --------------------------------------------------------------
                $total += $money * $val[ 'quantity' ];
            }
            # ------------------------------------------------------------------
            # 宅配要在加上運費
            # ------------------------------------------------------------------
            if( $_POST[ "Payment" ] == 2 )
            {
                $total = $total + 80;
            }
            # ------------------------------------------------------------------
            # 組成資訊
            # ------------------------------------------------------------------
            $order_id = $_POST[ "Payment" ] . date( "YmdHis" ).$_SESSION['Login_user']['id'];
            $insertArr = array();
            $insertArr[ 'user_id' ] = $_SESSION['Login_user']['id'];
            $insertArr[ 'name' ] = $_POST[ "name" ];
            $insertArr[ 'phone' ] = $_POST[ "phone" ];
            $insertArr[ 'address' ] = $_POST[ "address" ];
            $insertArr[ 'email' ] = $_POST[ "mail" ];
            $insertArr[ 'order_id' ] = $order_id;
            $insertArr[ 'typeid' ] = $_POST[ "Payment" ];
            $insertArr[ 'content' ] = $content;
            $insertArr[ 'createtime' ] = time();
            $insertArr[ "amount" ] = $total;
            # ------------------------------------------------------------------
            # 組合資料
            # ------------------------------------------------------------------
            if( Bootstart::$_lib[ 'Core_Pdo_Driver' ]->db_insert( 'orderdata' , $insertArr ) )
            {
                # --------------------------------------------------------------
                # 手動載入需要的類別
                # --------------------------------------------------------------
                Bootstart::$_lib[ 'Core_Loader' ]->library( array( 'LineNotify' ) );
                # --------------------------------------------------------------
                # 通知訊息內容
                # --------------------------------------------------------------
                $msg = "";
                $msg = "訂單號：".$order_id."請查收！！<br>";
                $msg .= $content;
                # --------------------------------------------------------------
                # 發送訊息
                # --------------------------------------------------------------
                Bootstart::$_lib[ 'Core_LineNotify' ]->myRoute( $msg );
                # --------------------------------------------------------------
                # 新增成功就刪除 session
                # --------------------------------------------------------------
                unset( $_SESSION[ 'cart' ] );
            }
            Core_Redirect( "Home" );
        }
    }

    /**
    @brief      商品明細轉二維
    **/
    private function arrToOne( )
    {
        $arr = array();
        # ----------------------------------------------------------------------
        # 取出文字檔
        # ----------------------------------------------------------------------
        $filename = DEVIL_SYSTEM_PATH . DIRECTORY_SEPARATOR . implode( DIRECTORY_SEPARATOR , array( "Player_Area" , "public" , "data" ,"product.txt" ) );
        if( file_exists( $filename ) )
        {
            $dataArr = file_get_contents( $filename );
            $dataArr = json_decode( $dataArr, true );
        }
        # ----------------------------------------------------------------------
        # 埅呆
        # ----------------------------------------------------------------------
        if( $dataArr )
        {
            foreach ( $dataArr as $key => $val) 
            {
                if( is_array( $val ) ) 
                {
                    $arr = array_merge( $arr, $val );
                } 
                else
                {
                    $arr[] = $val;
                }
            }
        }
        return $arr;
    }
    
        /**
    @brief      判斷是否登入狀態 , 並驗證 COOKIE 是否正常
    **/
    public function ISLogin()
    {
        # ----------------------------------------------------------------------
        # 判斷cookie登入
        # ----------------------------------------------------------------------
        if ( Core_IsLoginCookie() === false )
        {
            $this->responseJSON( '' , 400 , "0" );exit;
        }
        else
        {
            # ------------------------------------------------------------------
            # 導向至登入後的預設頁面
            # ------------------------------------------------------------------
            $this->responseJSON( '' , 200 , "1" );exit;
        }
    }
}