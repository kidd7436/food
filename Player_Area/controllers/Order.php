<?php if ( ! defined( 'DEVIL_SYS_CORE_PATH' ) ) exit( 'No direct script access allowed' );
/**
  @brief        Order Controller ( 訂單 )
**/

class Order extends Controller
{
    /**
    @brief      建構子
    **/
    public function __construct()
    {
        # ----------------------------------------------------------------------
        # 呼叫 "父類別" 的 __backstageInit Method
        # ----------------------------------------------------------------------
        $this->__backstageInit();
        # ----------------------------------------------------------------------
        # 手動載入需要的類別
        # ----------------------------------------------------------------------
        Bootstart::$_lib[ 'Core_Loader' ]->model( array( 'Product', 'KConfig' ) );
        # ----------------------------------------------------------------------
        # 重新建構類別
        # ----------------------------------------------------------------------
        $this->__initialization();
    }

    /**
    @brief      index處理導向
    **/
    public function index(  )
    {
        exit;
    }

    /**
    @brief      詳細
    **/
    public function OrderCheck(  )
    {
        # ----------------------------------------------------------------------
        # 輸出內容
        # ----------------------------------------------------------------------
        Bootstart::$_lib[ 'My_HtmlView' ]->Extension_HtmlView
        (
            "OrderCheck_Page" ,
            "OrderCheck.html" ,
            array
            (
                # --------------------------------------------------------------
                # 當前網址
                # --------------------------------------------------------------
                "URL" => DEVIL_APP_Url ,
                # --------------------------------------------------------------
                # JS、CSS、圖片等的存取網址
                # --------------------------------------------------------------
                "PUBLIC_URL" => DEVIL_APP_PUBLIC_URL ,
                # --------------------------------------------------------------
                # 網頁 TITLE
                # --------------------------------------------------------------
                "TITLE" => DEVIL_APP_PROJECT_NAME,
                # --------------------------------------------------------------
                # 姓名
                # --------------------------------------------------------------
                "NAME" => $_SESSION[ "Login_user" ][ "name" ],
                # --------------------------------------------------------------
                # 電話
                # --------------------------------------------------------------
                "PHONE" => $_SESSION[ "Login_user" ][ "phone" ],
                # --------------------------------------------------------------
                # 地址
                # --------------------------------------------------------------
                "ADDRESS" => $_SESSION[ "Login_user" ][ "address" ],
                # --------------------------------------------------------------
                # 地址
                # --------------------------------------------------------------
                "MAIL" => $_SESSION[ "Login_user" ][ "account" ],
                # --------------------------------------------------------------
                # POST_URL
                # --------------------------------------------------------------
                "ORDER_URL" => DEVIL_APP_Url.'Order/addPost' ,
                # --------------------------------------------------------------
                # 取出運費
                # --------------------------------------------------------------
                "SHIPPING" => Bootstart::$_mod[ 'KConfig_Model' ]->Get( "shipping" ) ,
                # ------------------------------------------------------------------
                # 取出免運設定
                # ------------------------------------------------------------------
                "SHIPPING_FREE" => Bootstart::$_mod[ 'KConfig_Model' ]->Get( "shipping_free" )
            )
        );
    }

    public function addPost()
    {
        if( Core_IsPost() && $_POST != '' )
        {
            # ------------------------------------------------------------------
            # 防呆
            # ------------------------------------------------------------------
            if( ! isset( $_POST[ "name" ] ) )
            {
                echo "<script>alert('收件人不得為空！！')</script>";
                exit( "<a href='javascript:history.back()'>回上一頁</a>" );
            }
            # ------------------------------------------------------------------
            # 防呆
            # ------------------------------------------------------------------
            if( ! isset( $_POST[ "phone" ] ) )
            {
                echo "<script>alert('電話不得為空！！')</script>";
                exit( "<a href='javascript:history.back()'>回上一頁</a>" );
            }
            # ------------------------------------------------------------------
            # 防呆
            # ------------------------------------------------------------------
            if( ! isset( $_POST[ "address" ] ) )
            {
                echo "<script>alert('地址不得為空！！')</script>";
                exit( "<a href='javascript:history.back()'>回上一頁</a>" );
            }
            # ------------------------------------------------------------------
            # 防呆
            # ------------------------------------------------------------------
            if( ! isset( $_POST[ "mail" ] ) )
            {
                echo "<script>alert('E-mail不得為空！！')</script>";
                exit( "<a href='javascript:history.back()'>回上一頁</a>" );
            }
            # ------------------------------------------------------------------
            # 防呆
            # ------------------------------------------------------------------
            if( ! isset( $_POST[ "content" ] ) )
            {
                echo "<script>alert('購物車為空，請重新操作！！')</script>";
                exit( "<a href='javascript:history.back()'>回上一頁</a>" );
            }
            # ------------------------------------------------------------------
            # 初始化
            # ------------------------------------------------------------------
            $money = $total = 0;
            $content  = "";
            # ------------------------------------------------------------------
            # 取出所有商品資料
            # ------------------------------------------------------------------
            $product = Bootstart::$_mod[ 'Product_Model' ]->arrToOne();
            # ------------------------------------------------------------------
            # 組合商品內容
            # ------------------------------------------------------------------
            foreach( $_POST[ "content" ] as $key => $val )
            {
                $dataArr = array();
                # --------------------------------------------------------------
                # 防呆 不符合就離開
                # --------------------------------------------------------------
                if( ! isset( $product[ $val[ "title" ] ] ) ) continue;
                # --------------------------------------------------------------
                # 商品內容暫存
                # --------------------------------------------------------------
                $dataArr = $product[ $val[ "title" ] ];
                # --------------------------------------------------------------
                # 商品內容
                # --------------------------------------------------------------
                $content .= $dataArr[ "title" ] . '*' .$val[ "quantity" ];
                # --------------------------------------------------------------
                # 取出金額
                # --------------------------------------------------------------
                $money = min( $dataArr[ "money" ], $dataArr[ "discount" ] );
                # --------------------------------------------------------------
                # 總計
                # --------------------------------------------------------------
                $total += $money * $val[ 'quantity' ];
            }
            # ------------------------------------------------------------------
            # 取出免運設定
            # ------------------------------------------------------------------
            $shipping_free =  Bootstart::$_mod[ 'KConfig_Model' ]->Get( "shipping_free" );
            # ------------------------------------------------------------------
            # 取出運費
            # ------------------------------------------------------------------
            $shipping =  Bootstart::$_mod[ 'KConfig_Model' ]->Get( "shipping" );
            # ------------------------------------------------------------------
            # 宅配要在加上運費
            # ------------------------------------------------------------------
            if( $_POST[ "Payment" ] == 1 && $total < $shipping_free )
            {
                $total = $total + $shipping;
            }
            # ------------------------------------------------------------------
            # 組成資訊
            # ------------------------------------------------------------------
            $order_id = $_POST[ "Payment" ] . date( "YmdHis" ).$_SESSION['Login_user']['id'];
            $insertArr = array();
            $insertArr[ 'user_id' ] = $_SESSION['Login_user']['id'];
            $insertArr[ 'name' ] = $_POST[ "name" ];
            $insertArr[ 'phone' ] = $_POST[ "phone" ];
            $insertArr[ 'address' ] = $_POST[ "address" ];
            $insertArr[ 'email' ] = $_POST[ "mail" ];
            $insertArr[ 'order_id' ] = $order_id;
            $insertArr[ 'typeid' ] = $_POST[ "Payment" ];
            $insertArr[ 'takeid' ] = $_POST[ "take" ];
            $insertArr[ 'content' ] = $content;
            $insertArr[ 'createtime' ] = time();
            $insertArr[ "amount" ] = $total;
            # ------------------------------------------------------------------
            # 組合資料
            # ------------------------------------------------------------------
            if( Bootstart::$_lib[ 'Core_Pdo_Driver' ]->db_insert( 'orderdata' , $insertArr ) )
            {
                # --------------------------------------------------------------
                # 手動載入需要的類別
                # --------------------------------------------------------------
                Bootstart::$_lib[ 'Core_Loader' ]->library( array( 'LineNotify' ) );
                # --------------------------------------------------------------
                # 通知訊息內容
                # --------------------------------------------------------------
                $msg = "";
                $msg = "訂單號：".$order_id."請查收！！<br>";
                $msg .= $content;
                # --------------------------------------------------------------
                # 發送訊息
                # --------------------------------------------------------------
                //Bootstart::$_lib[ 'Core_LineNotify' ]->myRoute( $msg );
            }
            Core_Redirect( "Account/Order" );
        }
    }
}